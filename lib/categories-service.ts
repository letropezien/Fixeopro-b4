export interface SubCategory {
  id: string
  name: string
  description?: string
  keywords?: string[]
}

export interface Category {
  id: string
  name: string
  icon: string
  description: string
  subCategories: SubCategory[]
  enabled: boolean
}

export class CategoriesService {
  private static readonly STORAGE_KEY = "fixeopro_categories"
  private static readonly SETTINGS_KEY = "fixeopro_category_settings"

  static getDefaultCategories(): Category[] {
    return [
      {
        id: "electromenager",
        name: "√âlectrom√©nager",
        icon: "üîå",
        description: "R√©paration et d√©pannage d'appareils √©lectrom√©nagers",
        enabled: true,
        subCategories: [
          { id: "lave-linge", name: "Lave-linge", description: "R√©paration lave-linge, tambour, pompe" },
          { id: "lave-vaisselle", name: "Lave-vaisselle", description: "D√©pannage lave-vaisselle, bras lavage" },
          { id: "refrigerateur", name: "R√©frig√©rateur", description: "R√©paration frigo, cong√©lateur, thermostat" },
          { id: "four", name: "Four", description: "R√©paration four √©lectrique, gaz, micro-ondes" },
          { id: "micro-ondes", name: "Micro-ondes", description: "D√©pannage micro-ondes, magn√©tron" },
          { id: "aspirateur", name: "Aspirateur", description: "R√©paration aspirateur, moteur, brosse" },
          { id: "seche-linge", name: "S√®che-linge", description: "D√©pannage s√®che-linge, r√©sistance" },
          { id: "cafetiere", name: "Cafeti√®re", description: "R√©paration machine √† caf√©, expresso" },
          { id: "robot-cuisine", name: "Robot de cuisine", description: "D√©pannage robot, mixeur, blender" },
          { id: "fer-repasser", name: "Fer √† repasser", description: "R√©paration fer, centrale vapeur" },
        ],
      },
      {
        id: "informatique",
        name: "Informatique",
        icon: "üíª",
        description: "D√©pannage informatique et r√©paration d'ordinateurs",
        enabled: true,
        subCategories: [
          {
            id: "ordinateur-portable",
            name: "Ordinateur portable",
            description: "R√©paration PC portable, √©cran, clavier",
          },
          { id: "ordinateur-fixe", name: "Ordinateur fixe", description: "D√©pannage PC fixe, tour, composants" },
          { id: "mac", name: "Mac", description: "R√©paration MacBook, iMac, Mac mini" },
          { id: "imprimante", name: "Imprimante", description: "D√©pannage imprimante, scanner, cartouches" },
          { id: "ecran", name: "√âcran", description: "R√©paration moniteur, √©cran LCD, LED" },
          { id: "disque-dur", name: "Disque dur", description: "R√©cup√©ration donn√©es, SSD, HDD" },
          { id: "virus", name: "Virus", description: "Nettoyage virus, malware, optimisation" },
          { id: "reseau", name: "R√©seau", description: "Configuration WiFi, box, routeur" },
          { id: "logiciel", name: "Logiciel", description: "Installation, configuration logiciels" },
          { id: "sauvegarde", name: "Sauvegarde", description: "Sauvegarde donn√©es, cloud, NAS" },
        ],
      },
      {
        id: "telephonie",
        name: "T√©l√©phonie",
        icon: "üì±",
        description: "R√©paration smartphone, tablette et accessoires",
        enabled: true,
        subCategories: [
          { id: "iphone", name: "iPhone", description: "R√©paration iPhone, √©cran, batterie" },
          { id: "samsung", name: "Samsung", description: "D√©pannage Samsung Galaxy, √©cran, charge" },
          { id: "huawei", name: "Huawei", description: "R√©paration Huawei, Honor, √©cran tactile" },
          { id: "xiaomi", name: "Xiaomi", description: "D√©pannage Xiaomi, Redmi, batterie" },
          { id: "tablette", name: "Tablette", description: "R√©paration iPad, tablette Android" },
          { id: "ecran-tactile", name: "√âcran tactile", description: "Remplacement √©cran cass√©, tactile" },
          { id: "batterie", name: "Batterie", description: "Changement batterie, autonomie" },
          { id: "connecteur-charge", name: "Connecteur de charge", description: "R√©paration prise charge, USB-C" },
          { id: "appareil-photo", name: "Appareil photo", description: "R√©paration cam√©ra, objectif" },
          { id: "haut-parleur", name: "Haut-parleur", description: "D√©pannage son, micro, √©couteurs" },
        ],
      },
      {
        id: "electronique",
        name: "√âlectronique",
        icon: "üì∫",
        description: "R√©paration TV, audio et √©lectronique grand public",
        enabled: true,
        subCategories: [
          { id: "television", name: "T√©l√©vision", description: "R√©paration TV LCD, LED, OLED, plasma" },
          { id: "console-jeux", name: "Console de jeux", description: "D√©pannage PlayStation, Xbox, Nintendo" },
          { id: "chaine-hifi", name: "Cha√Æne Hi-Fi", description: "R√©paration cha√Æne, amplificateur" },
          { id: "enceinte", name: "Enceinte", description: "D√©pannage enceinte, bluetooth, son" },
          { id: "casque", name: "Casque", description: "R√©paration casque audio, √©couteurs" },
          { id: "appareil-photo", name: "Appareil photo", description: "D√©pannage reflex, compact, objectif" },
          { id: "camescope", name: "Cam√©scope", description: "R√©paration cam√©ra, vid√©o" },
          { id: "drone", name: "Drone", description: "D√©pannage drone, h√©lice, cam√©ra" },
          { id: "montre-connectee", name: "Montre connect√©e", description: "R√©paration smartwatch, bracelet" },
          { id: "home-cinema", name: "Home cin√©ma", description: "Installation, d√©pannage syst√®me audio" },
        ],
      },
      {
        id: "plomberie",
        name: "Plomberie",
        icon: "üîß",
        description: "Intervention plomberie, fuite, d√©bouchage",
        enabled: true,
        subCategories: [
          { id: "fuite-eau", name: "Fuite d'eau", description: "R√©paration fuite, canalisation, joint" },
          { id: "debouchage", name: "D√©bouchage", description: "D√©bouchage √©vier, WC, canalisation" },
          { id: "chauffe-eau", name: "Chauffe-eau", description: "D√©pannage ballon eau chaude, r√©sistance" },
          { id: "robinetterie", name: "Robinetterie", description: "R√©paration robinet, mitigeur, cartouche" },
          { id: "wc", name: "WC", description: "D√©pannage toilettes, chasse d'eau, m√©canisme" },
          { id: "douche", name: "Douche", description: "R√©paration douche, pommeau, flexible" },
          { id: "baignoire", name: "Baignoire", description: "D√©pannage baignoire, vidage, joint" },
          {
            id: "lave-vaisselle-plomberie",
            name: "Raccordement lave-vaisselle",
            description: "Installation, raccordement",
          },
          { id: "lave-linge-plomberie", name: "Raccordement lave-linge", description: "Installation, √©vacuation" },
          { id: "canalisation", name: "Canalisation", description: "R√©paration tuyau, PVC, cuivre" },
        ],
      },
      {
        id: "electricite",
        name: "√âlectricit√©",
        icon: "‚ö°",
        description: "Installation √©lectrique, d√©pannage, mise aux normes",
        enabled: true,
        subCategories: [
          { id: "panne-electrique", name: "Panne √©lectrique", description: "D√©pannage coupure, court-circuit" },
          { id: "tableau-electrique", name: "Tableau √©lectrique", description: "R√©paration disjoncteur, diff√©rentiel" },
          {
            id: "prise-electrique",
            name: "Prise √©lectrique",
            description: "Installation, r√©paration prise, interrupteur",
          },
          { id: "eclairage", name: "√âclairage", description: "Installation luminaire, LED, variateur" },
          { id: "chauffage-electrique", name: "Chauffage √©lectrique", description: "D√©pannage radiateur, convecteur" },
          { id: "volet-roulant", name: "Volet roulant", description: "R√©paration moteur, t√©l√©commande" },
          { id: "portail-electrique", name: "Portail √©lectrique", description: "D√©pannage automatisme, moteur" },
          { id: "alarme", name: "Alarme", description: "Installation, d√©pannage syst√®me alarme" },
          { id: "videophone", name: "Visiophone", description: "Installation interphone, portier vid√©o" },
          { id: "mise-aux-normes", name: "Mise aux normes", description: "Conformit√© √©lectrique, diagnostic" },
        ],
      },
      {
        id: "chauffage",
        name: "Chauffage",
        icon: "üî•",
        description: "Entretien et r√©paration syst√®mes de chauffage",
        enabled: true,
        subCategories: [
          { id: "chaudiere-gaz", name: "Chaudi√®re gaz", description: "D√©pannage chaudi√®re gaz, entretien" },
          { id: "chaudiere-fioul", name: "Chaudi√®re fioul", description: "R√©paration chaudi√®re mazout, br√ªleur" },
          { id: "pompe-chaleur", name: "Pompe √† chaleur", description: "D√©pannage PAC air/eau, g√©othermie" },
          { id: "radiateur", name: "Radiateur", description: "R√©paration radiateur, purge, thermostat" },
          { id: "plancher-chauffant", name: "Plancher chauffant", description: "D√©pannage sol chauffant, r√©gulation" },
          { id: "poele-bois", name: "Po√™le √† bois", description: "Entretien po√™le, conduit, ramonage" },
          { id: "poele-granules", name: "Po√™le √† granul√©s", description: "D√©pannage po√™le pellets, vis sans fin" },
          { id: "insert", name: "Insert", description: "R√©paration insert, foyer ferm√©" },
          { id: "cheminee", name: "Chemin√©e", description: "Entretien chemin√©e, conduit, fum√©e" },
          { id: "regulation", name: "R√©gulation", description: "Programmateur, thermostat, sonde" },
        ],
      },
      {
        id: "climatisation",
        name: "Climatisation",
        icon: "‚ùÑÔ∏è",
        description: "Installation et d√©pannage climatisation",
        enabled: true,
        subCategories: [
          { id: "climatiseur-split", name: "Climatiseur split", description: "D√©pannage clim split, unit√© ext√©rieure" },
          { id: "climatiseur-mobile", name: "Climatiseur mobile", description: "R√©paration clim portable, gaz" },
          { id: "climatiseur-reversible", name: "Climatiseur r√©versible", description: "D√©pannage clim chaud/froid" },
          { id: "ventilation", name: "Ventilation", description: "VMC, extracteur, a√©ration" },
          { id: "recharge-gaz", name: "Recharge gaz", description: "Recharge fluide frigorig√®ne, R32" },
          { id: "nettoyage-clim", name: "Nettoyage climatisation", description: "Entretien, d√©sinfection, filtre" },
          {
            id: "installation-clim",
            name: "Installation climatisation",
            description: "Pose climatiseur, raccordement",
          },
          {
            id: "thermostat-clim",
            name: "Thermostat climatisation",
            description: "Programmateur, r√©gulation temp√©rature",
          },
        ],
      },
      {
        id: "serrurerie",
        name: "Serrurerie",
        icon: "üîê",
        description: "Ouverture porte, serrure, s√©curisation",
        enabled: true,
        subCategories: [
          {
            id: "ouverture-porte",
            name: "Ouverture de porte",
            description: "Porte claqu√©e, cl√© cass√©e, serrure bloqu√©e",
          },
          {
            id: "changement-serrure",
            name: "Changement serrure",
            description: "Remplacement serrure, cylindre, barillet",
          },
          {
            id: "blindage-porte",
            name: "Blindage de porte",
            description: "Porte blind√©e, s√©curisation, anti-effraction",
          },
          { id: "cles", name: "Cl√©s", description: "Reproduction cl√©s, cl√© cass√©e, double" },
          { id: "serrure-3-points", name: "Serrure 3 points", description: "Installation serrure multipoints" },
          {
            id: "serrure-electronique",
            name: "Serrure √©lectronique",
            description: "Serrure connect√©e, digicode, badge",
          },
          { id: "coffre-fort", name: "Coffre-fort", description: "Ouverture, installation coffre-fort" },
          { id: "rideau-metallique", name: "Rideau m√©tallique", description: "D√©pannage rideau, moteur, lames" },
          { id: "grille-securite", name: "Grille de s√©curit√©", description: "Installation grille, protection fen√™tre" },
        ],
      },
      {
        id: "vitrerie",
        name: "Vitrerie",
        icon: "ü™ü",
        description: "Remplacement vitre, miroiterie, double vitrage",
        enabled: true,
        subCategories: [
          { id: "vitre-cassee", name: "Vitre cass√©e", description: "Remplacement vitre, carreau, glace" },
          { id: "double-vitrage", name: "Double vitrage", description: "R√©paration double vitrage, bu√©e, joint" },
          { id: "miroir", name: "Miroir", description: "Pose miroir, d√©coupe sur mesure" },
          { id: "baie-vitree", name: "Baie vitr√©e", description: "R√©paration porte-fen√™tre, coulissant" },
          { id: "velux", name: "Velux", description: "D√©pannage fen√™tre de toit, m√©canisme" },
          { id: "vitrine", name: "Vitrine", description: "Remplacement vitrine magasin, commerce" },
          { id: "pare-brise", name: "Pare-brise", description: "R√©paration impact, remplacement" },
          { id: "verre-securite", name: "Verre s√©curis√©", description: "Verre tremp√©, feuillet√©, anti-effraction" },
        ],
      },
      {
        id: "menuiserie",
        name: "Menuiserie",
        icon: "ü™ö",
        description: "R√©paration bois, fen√™tre, porte, meuble",
        enabled: true,
        subCategories: [
          { id: "porte-bois", name: "Porte en bois", description: "R√©paration porte, gond, serrure" },
          { id: "fenetre-bois", name: "Fen√™tre bois", description: "D√©pannage fen√™tre, cr√©mone, joint" },
          { id: "volet-bois", name: "Volet bois", description: "R√©paration volet battant, persienne" },
          { id: "parquet", name: "Parquet", description: "R√©paration parquet, lame, pon√ßage" },
          { id: "escalier", name: "Escalier", description: "D√©pannage escalier, marche, rampe" },
          { id: "placard", name: "Placard", description: "R√©paration placard, porte coulissante" },
          { id: "meuble", name: "Meuble", description: "R√©paration meuble, tiroir, charni√®re" },
          { id: "cloison", name: "Cloison", description: "R√©paration cloison, placo, isolation" },
          { id: "terrasse-bois", name: "Terrasse bois", description: "Entretien terrasse, lame, structure" },
        ],
      },
      {
        id: "jardinage",
        name: "Jardinage",
        icon: "üå±",
        description: "Entretien jardin, r√©paration outils de jardinage",
        enabled: true,
        subCategories: [
          { id: "tondeuse", name: "Tondeuse", description: "R√©paration tondeuse, moteur, lame" },
          { id: "taille-haie", name: "Taille-haie", description: "D√©pannage taille-haie, lame, moteur" },
          { id: "tronconneuse", name: "Tron√ßonneuse", description: "R√©paration tron√ßonneuse, cha√Æne, guide" },
          { id: "debroussailleuse", name: "D√©broussailleuse", description: "D√©pannage d√©broussailleuse, fil, t√™te" },
          { id: "motoculteur", name: "Motoculteur", description: "R√©paration motobineuse, fraise, moteur" },
          { id: "souffleur", name: "Souffleur", description: "D√©pannage souffleur, aspirateur feuilles" },
          { id: "arrosage", name: "Arrosage", description: "Syst√®me arrosage automatique, programmateur" },
          { id: "serre", name: "Serre", description: "R√©paration serre, vitrage, structure" },
          { id: "portail-jardin", name: "Portail jardin", description: "D√©pannage portail, gond, serrure" },
          { id: "abri-jardin", name: "Abri de jardin", description: "R√©paration cabane, toiture, porte" },
        ],
      },
      {
        id: "automobile",
        name: "Automobile",
        icon: "üöó",
        description: "R√©paration automobile, diagnostic, entretien",
        enabled: true,
        subCategories: [
          { id: "diagnostic-auto", name: "Diagnostic", description: "Diagnostic √©lectronique, panne moteur" },
          { id: "batterie-auto", name: "Batterie", description: "Remplacement batterie, alternateur" },
          { id: "freinage", name: "Freinage", description: "R√©paration frein, plaquette, disque" },
          { id: "embrayage", name: "Embrayage", description: "D√©pannage embrayage, p√©dale, disque" },
          { id: "climatisation-auto", name: "Climatisation auto", description: "Recharge clim, compresseur, gaz" },
          { id: "echappement", name: "√âchappement", description: "R√©paration pot √©chappement, silencieux" },
          { id: "suspension", name: "Suspension", description: "Amortisseur, ressort, triangle" },
          { id: "carrosserie", name: "Carrosserie", description: "R√©paration carrosserie, rayure, bosse" },
          { id: "vitrage-auto", name: "Vitrage auto", description: "Pare-brise, vitre lat√©rale, impact" },
          { id: "electronique-auto", name: "√âlectronique auto", description: "Autoradio, GPS, calculateur" },
        ],
      },
      {
        id: "nettoyage",
        name: "Nettoyage",
        icon: "üßΩ",
        description: "Services de nettoyage et entretien",
        enabled: true,
        subCategories: [
          { id: "nettoyage-maison", name: "Nettoyage maison", description: "M√©nage, entretien domicile" },
          { id: "nettoyage-bureau", name: "Nettoyage bureau", description: "Entretien locaux professionnels" },
          { id: "nettoyage-vitres", name: "Nettoyage vitres", description: "Lavage vitres, baies vitr√©es" },
          { id: "nettoyage-moquette", name: "Nettoyage moquette", description: "Shampoing moquette, tapis" },
          { id: "nettoyage-facade", name: "Nettoyage fa√ßade", description: "Ravalement, nettoyage mur ext√©rieur" },
          { id: "demoussage", name: "D√©moussage", description: "D√©moussage toiture, terrasse" },
          { id: "desinfection", name: "D√©sinfection", description: "D√©sinfection, traitement sanitaire" },
        ],
      },
      {
        id: "demenagement",
        name: "D√©m√©nagement",
        icon: "üì¶",
        description: "Services de d√©m√©nagement et transport",
        enabled: true,
        subCategories: [
          { id: "demenagement-complet", name: "D√©m√©nagement complet", description: "D√©m√©nagement cl√© en main" },
          { id: "transport-meuble", name: "Transport meuble", description: "Livraison, transport mobilier" },
          { id: "emballage", name: "Emballage", description: "Emballage, protection objets fragiles" },
          { id: "stockage", name: "Stockage", description: "Garde-meuble, self-stockage" },
          { id: "monte-meuble", name: "Monte-meuble", description: "Monte-charge, grue, manutention" },
          { id: "nettoyage-fin-bail", name: "Nettoyage fin de bail", description: "M√©nage √©tat des lieux" },
        ],
      },
    ]
  }

  static getCategories(): Category[] {
    if (typeof window === "undefined") return this.getDefaultCategories()

    try {
      const stored = localStorage.getItem(this.STORAGE_KEY)
      if (stored) {
        const categories = JSON.parse(stored)
        // Fusionner avec les cat√©gories par d√©faut pour les nouvelles
        const defaultCategories = this.getDefaultCategories()
        const mergedCategories = defaultCategories.map((defaultCat) => {
          const storedCat = categories.find((cat: Category) => cat.id === defaultCat.id)
          return storedCat ? { ...defaultCat, ...storedCat } : defaultCat
        })
        return mergedCategories
      }
      return this.getDefaultCategories()
    } catch {
      return this.getDefaultCategories()
    }
  }

  static saveCategories(categories: Category[]): void {
    if (typeof window === "undefined") return
    localStorage.setItem(this.STORAGE_KEY, JSON.stringify(categories))
  }

  static getCategoryById(id: string): Category | null {
    const categories = this.getCategories()
    return categories.find((cat) => cat.id === id) || null
  }

  static getEnabledCategories(): Category[] {
    return this.getCategories().filter((cat) => cat.enabled)
  }

  static getSubCategoriesByCategory(categoryId: string): SubCategory[] {
    const category = this.getCategoryById(categoryId)
    return category?.subCategories || []
  }

  static toggleCategoryStatus(categoryId: string): void {
    const categories = this.getCategories()
    const categoryIndex = categories.findIndex((cat) => cat.id === categoryId)
    if (categoryIndex >= 0) {
      categories[categoryIndex].enabled = !categories[categoryIndex].enabled
      this.saveCategories(categories)
    }
  }

  static updateCategory(categoryId: string, updates: Partial<Category>): void {
    const categories = this.getCategories()
    const categoryIndex = categories.findIndex((cat) => cat.id === categoryId)
    if (categoryIndex >= 0) {
      categories[categoryIndex] = { ...categories[categoryIndex], ...updates }
      this.saveCategories(categories)
    }
  }

  static getSettings() {
    if (typeof window === "undefined") return { tvaEnabled: true, tvaRate: 20 }

    try {
      const stored = localStorage.getItem(this.SETTINGS_KEY)
      return stored ? JSON.parse(stored) : { tvaEnabled: true, tvaRate: 20 }
    } catch {
      return { tvaEnabled: true, tvaRate: 20 }
    }
  }

  static saveSettings(settings: { tvaEnabled: boolean; tvaRate: number }): void {
    if (typeof window === "undefined") return
    localStorage.setItem(this.SETTINGS_KEY, JSON.stringify(settings))
  }
}
